const { db } = require('../config/firebase');
const { hashPassword, comparePassword, generateToken, validateEmail } = require('../utils/helpers');

// In-memory storage for development
const memoryDB = {
    users: new Map(),
    verificationCodes: new Map() // NEW: Store verification codes
};

class User {
    constructor(data) {
        this.email = data.email;
        this.password = data.password;
        this.role = data.role;
        this.firstName = data.firstName;
        this.lastName = data.lastName;
        this.isVerified = data.isVerified || false; // CHANGED: Default to false
        this.verificationCode = data.verificationCode || null; // NEW: Verification code
        this.verificationExpires = data.verificationExpires || null; // NEW: Expiration
        this.createdAt = data.createdAt || new Date().toISOString();
        this.updatedAt = data.updatedAt || new Date().toISOString();
    }

    async save() {
        try {
            // Hash password
            const hashedPassword = await hashPassword(this.password);

            const userData = {
                email: this.email,
                password: hashedPassword,
                role: this.role,
                firstName: this.firstName,
                lastName: this.lastName,
                isVerified: this.isVerified, // CHANGED: Use dynamic value
                verificationCode: this.verificationCode, // NEW
                verificationExpires: this.verificationExpires, // NEW
                createdAt: this.createdAt,
                updatedAt: this.updatedAt
            };

            // Save to memoryDB
            memoryDB.users.set(this.email, userData);

            // Save to Firebase
            try {
                const userRef = db.collection('users').doc(this.email);
                await userRef.set(userData);
            } catch (firebaseError) {
                console.log('Development mode: Using memory storage');
            }

            return { 
                success: true, 
                user: { 
                    email: this.email, 
                    role: this.role, 
                    isVerified: this.isVerified,
                    verificationCode: this.verificationCode // NEW: Return for testing
                } 
            };
        } catch (error) {
            throw new Error('Error creating user: ' + error.message);
        }
    }

    static async findByEmail(email) {
        try {
            // Check memoryDB first
            if (memoryDB.users.has(email)) {
                return memoryDB.users.get(email);
            }

            // Fallback to Firebase
            const userRef = db.collection('users').doc(email);
            const userDoc = await userRef.get();

            if (userDoc.exists) {
                return userDoc.data();
            }
            return null;
        } catch (error) {
            return memoryDB.users.get(email) || null;
        }
    }

    // NEW: Store verification code
    static async storeVerificationCode(email, code) {
        const expiresAt = new Date();
        expiresAt.setMinutes(expiresAt.getMinutes() + 10); // 10 minutes expiry
        
        memoryDB.verificationCodes.set(email, {
            code,
            expiresAt: expiresAt.toISOString()
        });

        // Also update in user record
        const user = memoryDB.users.get(email);
        if (user) {
            user.verificationCode = code;
            user.verificationExpires = expiresAt.toISOString();
            
            // Update Firebase
            try {
                const userRef = db.collection('users').doc(email);
                await userRef.update({
                    verificationCode: code,
                    verificationExpires: expiresAt.toISOString()
                });
            } catch (error) {
                console.log('Development mode: Using memory storage for verification');
            }
        }
    }

    // NEW: Verify code
    static async verifyCode(email, code) {
        const storedData = memoryDB.verificationCodes.get(email);
        
        if (!storedData) {
            return { success: false, message: 'No verification code found' };
        }

        if (new Date() > new Date(storedData.expiresAt)) {
            memoryDB.verificationCodes.delete(email);
            return { success: false, message: 'Verification code expired' };
        }

        if (storedData.code !== code) {
            return { success: false, message: 'Invalid verification code' };
        }

        // Code is valid - mark user as verified
        memoryDB.verificationCodes.delete(email);
        
        const user = memoryDB.users.get(email);
        if (user) {
            user.isVerified = true;
            user.verificationCode = null;
            user.verificationExpires = null;
            user.updatedAt = new Date().toISOString();

            // Update Firebase
            try {
                const userRef = db.collection('users').doc(email);
                await userRef.update({
                    isVerified: true,
                    verificationCode: null,
                    verificationExpires: null,
                    updatedAt: new Date().toISOString()
                });
            } catch (error) {
                console.log('Development mode: Using memory storage for verification');
            }
        }

        return { success: true, message: 'Email verified successfully' };
    }

    static async verifyCredentials(email, password) {
        try {
            const user = await this.findByEmail(email);
            if (!user) {
                return { success: false, message: 'User not found' };
            }

            // NEW: Check if email is verified
            if (!user.isVerified) {
                return { 
                    success: false, 
                    message: 'Please verify your email address before logging in' 
                };
            }

            const isPasswordValid = await comparePassword(password, user.password);
            if (!isPasswordValid) {
                return { success: false, message: 'Invalid password' };
            }

            // Generate token
            const token = generateToken({
                email: user.email,
                role: user.role,
                firstName: user.firstName,
                lastName: user.lastName
            });

            return {
                success: true,
                user: {
                    email: user.email,
                    role: user.role,
                    firstName: user.firstName,
                    lastName: user.lastName,
                    isVerified: user.isVerified
                },
                token
            };
        } catch (error) {
            throw new Error('Error verifying credentials: ' + error.message);
        }
    }
}

module.exports = User;