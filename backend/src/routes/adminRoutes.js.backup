const express = require('express');
const { db } = require('../config/firebase');
const { authMiddleware } = require('../middleware/auth');

const router = express.Router();

// ====================================
// ADMIN DASHBOARD & STATISTICS
// ====================================

// @desc    Get admin dashboard statistics
// @route   GET /api/admin/dashboard
// @access  Private (Admin)
router.get('/dashboard', authMiddleware, async (req, res) => {
    try {
        // Check if user is admin
        if (req.user.role !== 'admin') {
            return res.status(403).json({
                success: false,
                message: 'Access denied. Admin role required.'
            });
        }

        // Get counts from all collections
        const [
            usersSnapshot,
            institutionsSnapshot,
            coursesSnapshot,
            applicationsSnapshot,
            companiesSnapshot,
            jobPostingsSnapshot
        ] = await Promise.all([
            db.collection('users').get(),
            db.collection('institutions').get(),
            db.collection('courses').get(),
            db.collection('applications').get(),
            db.collection('companies').get(),
            db.collection('jobPostings').get()
        ]);

        // Count users by role
        const userCounts = { student: 0, institute: 0, company: 0, admin: 0 };
        usersSnapshot.forEach(doc => {
            const user = doc.data();
            userCounts[user.role] = (userCounts[user.role] || 0) + 1;
        });

        // Count applications by status
        const applicationStats = { pending: 0, approved: 0, rejected: 0 };
        applicationsSnapshot.forEach(doc => {
            const application = doc.data();
            applicationStats[application.status] = (applicationStats[application.status] || 0) + 1;
        });

        const dashboardStats = {
            totalUsers: usersSnapshot.size,
            userCounts,
            totalInstitutions: institutionsSnapshot.size,
            totalCourses: coursesSnapshot.size,
            totalApplications: applicationsSnapshot.size,
            applicationStats,
            totalCompanies: companiesSnapshot.size,
            totalJobs: jobPostingsSnapshot.size,
            recentActivity: []
        };

        res.json({
            success: true,
            stats: dashboardStats
        });
    } catch (error) {
        console.error('Error fetching admin dashboard:', error);
        res.status(500).json({
            success: false,
            message: 'Failed to fetch dashboard data'
        });
    }
});

// ====================================
// INSTITUTION MANAGEMENT
// ====================================

// @desc    Get all institutions
// @route   GET /api/admin/institutions
// @access  Private (Admin)
router.get('/institutions', authMiddleware, async (req, res) => {
    try {
        if (req.user.role !== 'admin') {
            return res.status(403).json({ success: false, message: 'Access denied' });
        }

        const snapshot = await db.collection('institutions').get();
        const institutions = [];
        snapshot.forEach(doc => institutions.push({ id: doc.id, ...doc.data() }));

        res.json({ success: true, institutions });
    } catch (error) {
        res.status(500).json({ success: false, message: 'Failed to fetch institutions' });
    }
});

// @desc    Add new institution
// @route   POST /api/admin/institutions
// @access  Private (Admin)
router.post('/institutions', authMiddleware, async (req, res) => {
    try {
        if (req.user.role !== 'admin') {
            return res.status(403).json({ success: false, message: 'Access denied' });
        }

        const { name, email, address, phone, description, website } = req.body;

        const institutionData = {
            name,
            email,
            address,
            phone,
            description,
            website,
            status: 'active',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        const docRef = await db.collection('institutions').add(institutionData);

        res.status(201).json({
            success: true,
            message: 'Institution added successfully',
            institution: { id: docRef.id, ...institutionData }
        });
    } catch (error) {
        res.status(500).json({ success: false, message: 'Failed to add institution' });
    }
});

// @desc    Update institution
// @route   PUT /api/admin/institutions/:id
// @access  Private (Admin)
router.put('/institutions/:id', authMiddleware, async (req, res) => {
    try {
        if (req.user.role !== 'admin') {
            return res.status(403).json({ success: false, message: 'Access denied' });
        }

        const institutionId = req.params.id;
        const updateData = { ...req.body, updatedAt: new Date().toISOString() };

        await db.collection('institutions').doc(institutionId).update(updateData);

        res.json({
            success: true,
            message: 'Institution updated successfully'
        });
    } catch (error) {
        res.status(500).json({ success: false, message: 'Failed to update institution' });
    }
});

// @desc    Delete institution
// @route   DELETE /api/admin/institutions/:id
// @access  Private (Admin)
router.delete('/institutions/:id', authMiddleware, async (req, res) => {
    try {
        if (req.user.role !== 'admin') {
            return res.status(403).json({ success: false, message: 'Access denied' });
        }

        const institutionId = req.params.id;
        await db.collection('institutions').doc(institutionId).delete();

        res.json({
            success: true,
            message: 'Institution deleted successfully'
        });
    } catch (error) {
        res.status(500).json({ success: false, message: 'Failed to delete institution' });
    }
});

// ====================================
// COMPANY MANAGEMENT
// ====================================

// @desc    Get all companies
// @route   GET /api/admin/companies
// @access  Private (Admin)
router.get('/companies', authMiddleware, async (req, res) => {
    try {
        if (req.user.role !== 'admin') {
            return res.status(403).json({ success: false, message: 'Access denied' });
        }

        const snapshot = await db.collection('companies').get();
        const companies = [];
        snapshot.forEach(doc => companies.push({ id: doc.id, ...doc.data() }));

        res.json({ success: true, companies });
    } catch (error) {
        res.status(500).json({ success: false, message: 'Failed to fetch companies' });
    }
});

// @desc    Approve company
// @route   PUT /api/admin/companies/:id/approve
// @access  Private (Admin)
router.put('/companies/:id/approve', authMiddleware, async (req, res) => {
    try {
        if (req.user.role !== 'admin') {
            return res.status(403).json({ success: false, message: 'Access denied' });
        }

        const companyId = req.params.id;
        await db.collection('companies').doc(companyId).update({
            status: 'approved',
            updatedAt: new Date().toISOString()
        });

        res.json({
            success: true,
            message: 'Company approved successfully'
        });
    } catch (error) {
        res.status(500).json({ success: false, message: 'Failed to approve company' });
    }
});

// @desc    Suspend company
// @route   PUT /api/admin/companies/:id/suspend
// @access  Private (Admin)
router.put('/companies/:id/suspend', authMiddleware, async (req, res) => {
    try {
        if (req.user.role !== 'admin') {
            return res.status(403).json({ success: false, message: 'Access denied' });
        }

        const companyId = req.params.id;
        await db.collection('companies').doc(companyId).update({
            status: 'suspended',
            updatedAt: new Date().toISOString()
        });

        res.json({
            success: true,
            message: 'Company suspended successfully'
        });
    } catch (error) {
        res.status(500).json({ success: false, message: 'Failed to suspend company' });
    }
});

// @desc    Delete company
// @route   DELETE /api/admin/companies/:id
// @access  Private (Admin)
router.delete('/companies/:id', authMiddleware, async (req, res) => {
    try {
        if (req.user.role !== 'admin') {
            return res.status(403).json({ success: false, message: 'Access denied' });
        }

        const companyId = req.params.id;
        await db.collection('companies').doc(companyId).delete();

        res.json({
            success: true,
            message: 'Company deleted successfully'
        });
    } catch (error) {
        res.status(500).json({ success: false, message: 'Failed to delete company' });
    }
});

// ====================================
// USER MANAGEMENT
// ====================================

// @desc    Get all users
// @route   GET /api/admin/users
// @access  Private (Admin)
router.get('/users', authMiddleware, async (req, res) => {
    try {
        if (req.user.role !== 'admin') {
            return res.status(403).json({ success: false, message: 'Access denied' });
        }

        const snapshot = await db.collection('users').get();
        const users = [];
        snapshot.forEach(doc => users.push({ id: doc.id, ...doc.data() }));

        res.json({ success: true, users });
    } catch (error) {
        res.status(500).json({ success: false, message: 'Failed to fetch users' });
    }
});

// @desc    Update user status
// @route   PUT /api/admin/users/:id/status
// @access  Private (Admin)
router.put('/users/:id/status', authMiddleware, async (req, res) => {
    try {
        if (req.user.role !== 'admin') {
            return res.status(403).json({ success: false, message: 'Access denied' });
        }

        const userId = req.params.id;
        const { status } = req.body;

        await db.collection('users').doc(userId).update({
            status,
            updatedAt: new Date().toISOString()
        });

        res.json({
            success: true,
            message: 'User status updated successfully'
        });
    } catch (error) {
        res.status(500).json({ success: false, message: 'Failed to update user status' });
    }
});

// ====================================
// SYSTEM REPORTS
// ====================================

// @desc    Get system reports
// @route   GET /api/admin/reports
// @access  Private (Admin)
router.get('/reports', authMiddleware, async (req, res) => {
    try {
        if (req.user.role !== 'admin') {
            return res.status(403).json({ success: false, message: 'Access denied' });
        }

        // Get comprehensive system data for reports
        const [
            usersSnapshot,
            institutionsSnapshot,
            coursesSnapshot,
            applicationsSnapshot,
            companiesSnapshot
        ] = await Promise.all([
            db.collection('users').get(),
            db.collection('institutions').get(),
            db.collection('courses').get(),
            db.collection('applications').get(),
            db.collection('companies').get()
        ]);

        const reports = {
            userGrowth: calculateMonthlyGrowth(usersSnapshot),
            applicationTrends: calculateApplicationTrends(applicationsSnapshot),
            institutionPerformance: calculateInstitutionPerformance(institutionsSnapshot, applicationsSnapshot),
            systemUsage: calculateSystemUsage(usersSnapshot, applicationsSnapshot)
        };

        res.json({ success: true, reports });
    } catch (error) {
        res.status(500).json({ success: false, message: 'Failed to generate reports' });
    }
});

// Helper functions for reports
function calculateMonthlyGrowth(snapshot) {
    // Simplified calculation - in real app, you'd group by month
    return {
        total: snapshot.size,
        growth: 15.5 // Example growth percentage
    };
}

function calculateApplicationTrends(snapshot) {
    const trends = { pending: 0, approved: 0, rejected: 0 };
    snapshot.forEach(doc => {
        const app = doc.data();
        trends[app.status] = (trends[app.status] || 0) + 1;
    });
    return trends;
}

function calculateInstitutionPerformance(institutionsSnapshot, applicationsSnapshot) {
    // Simplified performance calculation
    return institutionsSnapshot.size;
}

function calculateSystemUsage(usersSnapshot, applicationsSnapshot) {
    return {
        activeUsers: usersSnapshot.size,
        totalApplications: applicationsSnapshot.size,
        engagementRate: 75.2 // Example engagement rate
    };
}

module.exports = router;

// ====================================
// FACULTY MANAGEMENT
// ====================================

// @desc    Get faculties by institution
// @route   GET /api/admin/institutions/:id/faculties
// @access  Private (Admin)
router.get('/institutions/:id/faculties', authMiddleware, async (req, res) => {
    try {
        if (req.user.role !== 'admin') {
            return res.status(403).json({ success: false, message: 'Access denied' });
        }

        const institutionId = req.params.id;
        const snapshot = await db.collection('faculties')
            .where('institutionId', '==', institutionId)
            .get();

        const faculties = [];
        snapshot.forEach(doc => faculties.push({ id: doc.id, ...doc.data() }));

        res.json({ success: true, faculties });
    } catch (error) {
        res.status(500).json({ success: false, message: 'Failed to fetch faculties' });
    }
});

// @desc    Add faculty to institution
// @route   POST /api/admin/institutions/:id/faculties
// @access  Private (Admin)
router.post('/institutions/:id/faculties', authMiddleware, async (req, res) => {
    try {
        if (req.user.role !== 'admin') {
            return res.status(403).json({ success: false, message: 'Access denied' });
        }

        const institutionId = req.params.id;
        const { name, description, dean, contactEmail } = req.body;

        const facultyData = {
            institutionId,
            name,
            description,
            dean,
            contactEmail,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        const docRef = await db.collection('faculties').add(facultyData);

        res.status(201).json({
            success: true,
            message: 'Faculty added successfully',
            faculty: { id: docRef.id, ...facultyData }
        });
    } catch (error) {
        res.status(500).json({ success: false, message: 'Failed to add faculty' });
    }
});

// @desc    Update faculty
// @route   PUT /api/admin/faculties/:id
// @access  Private (Admin)
router.put('/faculties/:id', authMiddleware, async (req, res) => {
    try {
        if (req.user.role !== 'admin') {
            return res.status(403).json({ success: false, message: 'Access denied' });
        }

        const facultyId = req.params.id;
        const updateData = { ...req.body, updatedAt: new Date().toISOString() };

        await db.collection('faculties').doc(facultyId).update(updateData);

        res.json({
            success: true,
            message: 'Faculty updated successfully'
        });
    } catch (error) {
        res.status(500).json({ success: false, message: 'Failed to update faculty' });
    }
});

// @desc    Delete faculty
// @route   DELETE /api/admin/faculties/:id
// @access  Private (Admin)
router.delete('/faculties/:id', authMiddleware, async (req, res) => {
    try {
        if (req.user.role !== 'admin') {
            return res.status(403).json({ success: false, message: 'Access denied' });
        }

        const facultyId = req.params.id;
        await db.collection('faculties').doc(facultyId).delete();

        res.json({
            success: true,
            message: 'Faculty deleted successfully'
        });
    } catch (error) {
        res.status(500).json({ success: false, message: 'Failed to delete faculty' });
    }
});

// ====================================
// COURSE MANAGEMENT
// ====================================

// @desc    Get courses by faculty
// @route   GET /api/admin/faculties/:id/courses
// @access  Private (Admin)
router.get('/faculties/:id/courses', authMiddleware, async (req, res) => {
    try {
        if (req.user.role !== 'admin') {
            return res.status(403).json({ success: false, message: 'Access denied' });
        }

        const facultyId = req.params.id;
        const snapshot = await db.collection('courses')
            .where('facultyId', '==', facultyId)
            .get();

        const courses = [];
        snapshot.forEach(doc => courses.push({ id: doc.id, ...doc.data() }));

        res.json({ success: true, courses });
    } catch (error) {
        res.status(500).json({ success: false, message: 'Failed to fetch courses' });
    }
});

// @desc    Add course to faculty
// @route   POST /api/admin/faculties/:id/courses
// @access  Private (Admin)
router.post('/faculties/:id/courses', authMiddleware, async (req, res) => {
    try {
        if (req.user.role !== 'admin') {
            return res.status(403).json({ success: false, message: 'Access denied' });
        }

        const facultyId = req.params.id;
        const { 
            name, 
            description, 
            duration, 
            requirements, 
            tuitionFee, 
            availableSeats,
            applicationDeadline,
            intake 
        } = req.body;

        // Get faculty and institution info
        const facultyDoc = await db.collection('faculties').doc(facultyId).get();
        if (!facultyDoc.exists) {
            return res.status(404).json({ success: false, message: 'Faculty not found' });
        }

        const faculty = facultyDoc.data();
        const institutionDoc = await db.collection('institutions').doc(faculty.institutionId).get();
        const institution = institutionDoc.data();

        const courseData = {
            facultyId,
            institutionId: faculty.institutionId,
            name,
            description,
            duration,
            requirements,
            tuitionFee,
            availableSeats: parseInt(availableSeats),
            applicationDeadline,
            intake,
            institution: institution.name,
            faculty: faculty.name,
            status: 'active',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        const docRef = await db.collection('courses').add(courseData);

        res.status(201).json({
            success: true,
            message: 'Course added successfully',
            course: { id: docRef.id, ...courseData }
        });
    } catch (error) {
        res.status(500).json({ success: false, message: 'Failed to add course' });
    }
});

// @desc    Update course
// @route   PUT /api/admin/courses/:id
// @access  Private (Admin)
router.put('/courses/:id', authMiddleware, async (req, res) => {
    try {
        if (req.user.role !== 'admin') {
            return res.status(403).json({ success: false, message: 'Access denied' });
        }

        const courseId = req.params.id;
        const updateData = { ...req.body, updatedAt: new Date().toISOString() };

        await db.collection('courses').doc(courseId).update(updateData);

        res.json({
            success: true,
            message: 'Course updated successfully'
        });
    } catch (error) {
        res.status(500).json({ success: false, message: 'Failed to update course' });
    }
});

// @desc    Delete course
// @route   DELETE /api/admin/courses/:id
// @access  Private (Admin)
router.delete('/courses/:id', authMiddleware, async (req, res) => {
    try {
        if (req.user.role !== 'admin') {
            return res.status(403).json({ success: false, message: 'Access denied' });
        }

        const courseId = req.params.id;
        await db.collection('courses').doc(courseId).delete();

        res.json({
            success: true,
            message: 'Course deleted successfully'
        });
    } catch (error) {
        res.status(500).json({ success: false, message: 'Failed to delete course' });
    }
});

// ====================================
// ADMISSIONS MANAGEMENT
// ====================================

// @desc    Get all admissions
// @route   GET /api/admin/admissions
// @access  Private (Admin)
router.get('/admissions', authMiddleware, async (req, res) => {
    try {
        if (req.user.role !== 'admin') {
            return res.status(403).json({ success: false, message: 'Access denied' });
        }

        const snapshot = await db.collection('applications')
            .orderBy('applicationDate', 'desc')
            .get();

        const admissions = [];
        snapshot.forEach(doc => admissions.push({ id: doc.id, ...doc.data() }));

        res.json({ success: true, admissions });
    } catch (error) {
        res.status(500).json({ success: false, message: 'Failed to fetch admissions' });
    }
});

// @desc    Publish admission results
// @route   POST /api/admin/admissions/publish
// @access  Private (Admin)
router.post('/admissions/publish', authMiddleware, async (req, res) => {
    try {
        if (req.user.role !== 'admin') {
            return res.status(403).json({ success: false, message: 'Access denied' });
        }

        const { applicationIds, status } = req.body;

        const batch = db.batch();
        
        for (const appId of applicationIds) {
            const appRef = db.collection('applications').doc(appId);
            batch.update(appRef, { 
                status,
                decisionDate: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            });
        }

        await batch.commit();

        res.json({
            success: true,
            message: `Admission results published for ${applicationIds.length} applications`
        });
    } catch (error) {
        res.status(500).json({ success: false, message: 'Failed to publish admissions' });
    }
});
